<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title> auth </title>
<style>
    /* ================= loading-with-dot ===================== */
.loading-with-dot {
  display: inline-block;
  width: 10px;
  min-height: 2px;
  padding-right: 2px;
  border-left: 2px solid currentColor;
  border-right: 2px solid currentColor;
  background-color: currentColor;
  background-clip: content-box;
  box-sizing: border-box;
  -webkit-animation: dot 4s infinite step-start both;
  animation: dot 4s infinite step-start both;
  *zoom: expression(this.innerHTML = '...');
  /* IE7 */
  /* IE8 */
}
.loading-with-dot:before {
  content: '...';
}
.loading-with-dot::before {
  content: '';
}

:root .loading-with-dot {
  margin-left: 2px;
  padding-left: 2px;
}

/* IE9+ */
@-webkit-keyframes dot {
  25% {
    border-color: transparent;
    background-color: transparent;
  }
  /* zero point */
  50% {
    border-right-color: transparent;
    background-color: transparent;
  }
  /* one point */
  75% {
    border-right-color: transparent;
  }
  /* two points */
}
@keyframes dot {
  25% {
    border-color: transparent;
    background-color: transparent;
  }
  /* zero point */
  50% {
    border-right-color: transparent;
    background-color: transparent;
  }
  /* one point */
  75% {
    border-right-color: transparent;
  }
  /* two points */
}
h1 {
    padding: 0;
    margin: 0;
    height: 300px; 
    line-height: 300px;
    text-align: center;
    font-size: 20px;
}
</style>
</head>

<body>
    <div style="position:fixed; margin:auto; left:0; right: 0; top: 0; bottom: 0; width: 300px; height: 300px;">
        <h1>身份认证中<span class="loading-with-dot"></span></h1>
    </div>
</body>

<script>

    var apiUrl = 'http://api.hizuoye.com/api/v1/';
    var url = window.location.href;
    var re = /([?&])(code|next)=([^?&]+)/g;
    var query = {}, matches;
    function createXHR(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
            // Check if the XMLHttpRequest object has a "withCredentials" property.
            // "withCredentials" only exists on XMLHTTPRequest2 objects.
            xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
            // Otherwise, check if XDomainRequest.
            // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
            xhr = new XDomainRequest();
            xhr.open(method, url);
        } else {
            // Otherwise, CORS is not supported by the browser.
            xhr = null;
        }
        return xhr;
    }

    while (matches = re.exec(url)) {
        query[matches[2]] = matches[3];
    }

    var next = query.next;
    var code = query.code;

    var nextMap = {
        microsite: './microsite.html',
        homework: './homework.html',
        evaluation: './homework.html#!/evaluation',
        mistake: './homework.html#!/mistake/list',
        task: './task.html',
        mall: './task.html#!/mall',
        rank: './task.html#!/rank'
    }

    var nextUrl = nextMap[next];

    if (code) {
        var xhr = createXHR("GET", apiUrl + 'public/auth?code=' + code + "&url=" + btoa(url));
        if (!xhr) {
            alert('CORS not supported');
        }
        // Response handlers.
        xhr.onload = function () {
            var status = xhr.status;
            if (status === 200) { // binded user and qo next...
                // location.href = next + '.html?token=' + xhr.responseText;
                if ( localStorage && localStorage.getItem ) {
                    localStorage.setItem('illy-token', xhr.responseText);
                    location.replace(nextUrl); // pure url
                } else {
                    console.error('不支持本地存储，token获取不到');
                    alert('localStorage not support, no token');
                }
            } else if ( status === 401) { // unbinded user and go login...
                var openid = xhr.responseText;
                location.replace('login.html?openid=' + openid + '&next=' + nextUrl);
            } else {
                alert("Error Sorry! Error: " + xhr.responseText + "status is " + status + ", url = " + url);
            }
        }

        xhr.onerror = function () {
            alert('Woops, there was an error making the request.');
        };

        xhr.send(null);
    }

</script>
</html>

