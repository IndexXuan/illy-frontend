define([],function(){var apiBaseUrl=avalon.illyGlobal.apiBaseUrl||"http://api.hizuoye.com/api/v1/",token=avalon.illyGlobal.token,wx=avalon.wx,cachedPrefix="illy-task-activity-",copyArr=function(arr){for(var brr=[],i=0,len=arr.length;len>i;i++)brr[i]=arr[i];return brr},dataAdapter=function(source){for(var arr=copyArr(source),i=2,len=arr.length;len>i;i++)arr[i]={key:activity.CopyinfoCollect[i],value:arr[i]};arr.shift(),arr.shift();var infoJSON=arr;return{name:source[0],phone:source[1],others:infoJSON}},activity=avalon.define({$id:"activity",visited:!1,isDone:!1,isCancel:!1,isFilling:!1,taskId:1,scoreAward:10,address:"",content:"",startTime:"",endTime:"",deadline:"",shareCount:88,visitCount:88,likeCount:0,infoCollect:[],CopyinfoCollect:[],theme:"",isShared:!1,updateShare:function(){$http.ajax({method:"PUT",url:apiBaseUrl+"public/activities/"+activity.taskId+"/share",headers:{Authorization:"Bearer "+token},success:function(){},error:function(res){console.log(res)},ajaxFail:function(res){console.log(res)}})},hasLiked:!1,updateLike:function(){$http.ajax({method:"PUT",url:apiBaseUrl+"public/posts/"+activity.taskId+"/like",headers:{Authorization:"Bearer "+token},success:function(){var likeCount=activity.likeCount||0;activity.likeCount=++likeCount},error:function(res){console.log(res)},ajaxFail:function(res){console.log(res)}})},like:function(){activity.updateLike(),avalon.setLocalCache(cachedPrefix+activity.taskId+"-like","hasLiked"),activity.hasLiked=!0},filling:function(){activity.isFilling=!0},cancel:function(){activity.isCancel=!0,activity.isFilling=!1},pushInfo:function(){var validPhone=function(phone){return/^\d{3,}$/.test(phone)},valid=""!==activity.infoCollect[0]&&validPhone(activity.infoCollect[1]);return valid?void $http.ajax({method:"POST",url:apiBaseUrl+"public/activities/"+activity.taskId+"/info",headers:{Authorization:"Bearer "+token},data:dataAdapter(activity.infoCollect),success:function(){activity.isDone=!0,activity.isFilling=!1,avalon.setLocalCache(cachedPrefix+activity.taskId+"-isSignUp","signUp")},error:function(res){console.log(res)},ajaxFail:function(res){console.log(res)}}):void alert("请填写信息完整，格式正确的报名信息，谢谢!")},fetchData:function(){if(activity.visited&&activity.hasData){var localCache=avalon.getLocalCache(cachedPrefix+activity.taskId);return activity.taskId=localCache._id,activity.address=localCache.address,activity.content=localCache.content,activity.startTime=localCache.startTime,activity.endTime=localCache.endTime,activity.deadline=localCache.deadline,activity.shareCount=localCache.shareCount,activity.visitCount=localCache.visitCount,activity.infoCollect=localCache.infoCollect[0],activity.CopyinfoCollect=localCache.infoCollect[0],void(activity.theme=localCache)}$http.ajax({url:apiBaseUrl+"tasks/"+activity.taskId,headers:{Authorization:"Bearer "+token},dataType:"json",success:function(json){activity.taskId=json._id,activity.address=json.address,activity.content=json.content,activity.startTime=json.startTime,activity.endTime=json.endTime,activity.deadline=json.deadline,activity.shareCount=json.shareCount,activity.visitCount=json.visitCount,json.infoCollect.unshift("姓名","电话"),activity.infoCollect=json.infoCollect;for(var i=0,len=activity.infoCollect.length;len>i;i++)activity.infoCollect[i]="";activity.CopyinfoCollect=json.infoCollect,activity.theme=json.theme,avalon.setLocalCache(cachedPrefix+activity.taskId,json),wx.onMenuShareTimeline({title:activity.title,link:"",imgUrl:document.getElementsByTagName("img")[0].src,success:function(){activity.shareCount++,activity.isShared=!0,activity.updateShare()},cancel:function(){alert("差一点就能完成任务拿积分了!")}})}})}});return avalon.controller(function($ctrl){$ctrl.$onRendered=function(){var signUp=avalon.getLocalCache(cachedPrefix+activity.taskId+"-isSignUp");"signUp"===signUp&&(activity.isDone=!0,activity.isFilling=!1),avalon.$(".gotop").onclick=function(){document.body.scrollTop=0,document.documentElement.scrollTop=0},setTimeout(function(){var gotop=avalon.$("#gotop");gotop&&(gotop.style.display="block")},3e3)},$ctrl.$onEnter=function(params){activity.taskId=params.taskId,activity.scoreAward=params.scoreAward,activity.visited=avalon.vmodels.root.currentIsVisited,activity.isShared=!1,activity.fetchData()},$ctrl.$onBeforeUnload=function(){},$ctrl.$vmodels=[]})});
//# sourceMappingURL=state-activity.js.map