!function(gmu,$){gmu.define("Historylist",{options:{container:document.body,deleteSupport:!0,items:[]},template:{wrap:'<ul class="ui-historylist">',item:'<li data-id="<%=id%>"><p class="ui-historylist-itemwrap"><span class="ui-historylist-item"><%=context%></span></p></li>',clear:'<p class="ui-historylist-clear">清空搜索历史</p>'},_init:function(){var me=this,opts=me._options;me.$el=opts.container=opts.container||document.body,me.items=[],me.on("ready",function(){me._bindUI()}),me.on("itemDelete",function(){0===me.items.length&&me.hide()})},_create:function(){var me=this,opts=me._options;me.$el.hide(),me.$wrap=$(me.tpl2html("wrap")).appendTo(opts.container),me.$clear=$(me.tpl2html("clear")).appendTo(opts.container),!me._options.deleteSupport&&me.$clear.hide(),me.addItems(opts.items),me.show()},_filterItemsById:function(id,callback){var me=this;me.items.forEach(function(_item,index){return _item.id===id?void callback.call(me,_item,index):void 0})},_bindUI:function(){var touch,$target,itemId,startTimestamp,endTimestamp,timeout,touchstartX,currentX,touchstartY,currentY,velocity,movedPercentage,moved,movedDistance,me=this,wantDelete=!1;me.$clear.on("tap"+me.eventNs,function(ev){setTimeout(function(){gmu.Dialog({closeBtn:!1,buttons:{"清空":function(){me.clear(),this.destroy()},"取消":function(){this.destroy()}},title:"清空历史",content:"<p>是否清空搜索历史？</p>",open:function(){this._options._wrap.addClass("ui-historylist-dialog")}})},10),ev.preventDefault(),ev.stopPropagation()}),me.$wrap.on("tap"+me.eventNs,function(ev){if(!me._options.deleteSupport){if($target=$(ev.target),!$target.hasClass("ui-historylist-itemwrap")&&!($target=$target.parents(".ui-historylist-itemwrap")).length)return void($target=null);itemId=$target.parent().attr("data-id"),me._filterItemsById(itemId,function(_item){me.trigger("itemTouch",{item:_item.value})})}}),me.$wrap.on("touchstart"+me.eventNs,function(ev){if(me._options.deleteSupport){if(touch=ev.touches[0],$target=$(touch.target),startTimestamp=ev.timeStamp,currentX=touchstartX=parseInt(touch.pageX),currentY=touchstartY=parseInt(touch.pageY),moved=!1,wantDelete=!1,!$target.hasClass("ui-historylist-itemwrap")&&!($target=$target.parents(".ui-historylist-itemwrap")).length)return void($target=null);$target.addClass("ui-historylist-ontap"),$target.css("width",$target.width()-parseInt($target.css("border-left-width"))-parseInt($target.css("border-right-width")))}}),me.$wrap.on("touchmove"+me.eventNs,function(ev){if($target){if(currentX=ev.touches[0].pageX,currentY=ev.touches[0].pageY,void 0===timeout&&(timeout=setTimeout(function(){wantDelete=Math.abs(currentY-touchstartY)>Math.abs(currentX-touchstartX)/2?!1:!0},10)),moved=moved||(currentX-touchstartX>=3||currentY-touchstartY>=3?!0:!1),!wantDelete)return void setTimeout(function(){$target&&$target.removeClass("ui-historylist-ontap")},150);movedPercentage=(currentX-touchstartX)/me.$wrap.width(),$target.addClass("ui-historylist-itemmoving"),$target.removeClass("ui-historylist-ontap"),$target.css("-webkit-transform","translate3d("+(currentX-touchstartX)+"px, 0, 0)"),$target.css("opacity",1-movedPercentage),ev.preventDefault(),ev.stopPropagation()}}),me.$wrap.on("touchend"+me.eventNs+" touchcancel"+me.eventNs,function(ev){$target&&(clearTimeout(timeout),timeout=void 0,itemId=$target.parent().attr("data-id"),endTimestamp=ev.timeStamp,velocity=(currentX-touchstartX)/(endTimestamp-startTimestamp),movedDistance=Math.abs(currentX-touchstartX),$target.removeClass("ui-historylist-ontap"),$target.removeClass("ui-historylist-itemmoving"),movedDistance<me.$wrap.width()/3&&Math.abs(velocity)>.1&&wantDelete||movedDistance>=me.$wrap.width()/3&&wantDelete?me.removeItem(itemId,$target):($target.css("width","auto"),$target.css("-webkit-transform","translate3d(0, 0, 0)"),$target.css("opacity",1),!moved&&3>movedDistance&&me._filterItemsById(itemId,function(_item){me.trigger("itemTouch",{item:_item.value})})),$target=null)})},show:function(){var me=this;if(0!==me.items.length)return me.sync===!1&&(me.$wrap.html(""),me.addItems(me.syncitems),me.sync=!0),me.$el.show(),me.isShow=!0,me},hide:function(){var me=this;return me.$el.hide(),me.isShow=!1,me},_getItemId:function(){var me=this;return void 0===me._itemId?me._itemId=1:++me._itemId,"__dd__"+me._itemId},_getFormatItem:function(item){var me=this;return"[object String]"===Object.prototype.toString.call(item)?{context:item,value:item,id:me._getItemId()}:{context:item.context||item.value,value:item.value||item.context,id:me._getItemId()}},addItem:function(item){var me=this,item=me._getFormatItem(item);return me.items.forEach(function(_item,index){return _item.value===item.value?(me.items.splice(index,1),void $(me.$wrap.children()[index]).remove()):void 0}),0===me.$wrap.children().length?me.$wrap.append(me.tpl2html("item",item)):$(me.tpl2html("item",item)).insertBefore(me.$wrap.children()[0]),me.items.unshift(item),me},addItems:function(items){var me=this;return items.forEach(function(item){me.addItem(item)}),me},update:function(items){var me=this;return me.isShow?(me.$wrap.html(""),me.addItems(items),me.sync=!0):(me.syncitems=items,me.sync=!1),me},removeItem:function(itemId,$itemTarget){var distance,transform,x,me=this;transform=$itemTarget.css("-webkit-transform"),x=/translate3d\((.*?),.*/.test(transform)?RegExp.$1:0,distance=parseInt(x,10)>=0?$itemTarget.width():-$itemTarget.width(),$itemTarget.css("-webkit-transform","translate3d("+distance+"px, 0, 0)"),$itemTarget.on("transitionEnd"+me.eventNs+" webkitTransitionEnd"+me.eventNs,function(){$itemTarget.parent().remove(),me._filterItemsById(itemId,function(_item,index){me.items.splice(index,1),me.trigger("itemDelete",{item:_item.value})})})},clear:function(){var me=this;return me.$wrap.html(""),me.items=[],me.sync=!0,me.hide(),me.trigger("clear"),me},disableDelete:function(){var me=this;return me._options.deleteSupport=!1,me.$clear.hide(),me},enableDelete:function(){var me=this;return me._options.deleteSupport=!0,me.$clear.show(),me},destroy:function(){var me=this;return me.$wrap.off(me.eventNs),me.$clear.off(me.eventNs),me.$wrap.remove(),me.$clear.remove(),me.$super("destroy")}})}(gmu,gmu.$);
//# sourceMappingURL=historylist.js.map