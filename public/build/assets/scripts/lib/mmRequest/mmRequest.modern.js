define("mmRequest",["avalon","mmPromise"],function(avalon){function IE(){if(window.VBArray){var mode=document.documentMode;return mode?mode:window.XMLHttpRequest?7:6}return 0}function parseJS(code){var indirect=eval;if(code=code.trim())if(1===code.indexOf("use strict")){var script=document.createElement("script");script.text=code,head.appendChild(script).parentNode.removeChild(script)}else indirect(code)}function parseXML(data,xml){var xml;if(!data||"string"!=typeof data)return null;try{xml=(new DOMParser).parseFromString(data,"text/xml")}catch(e){xml=void 0}return(!xml||xml.getElementsByTagName("parsererror").length)&&avalon.error("Invalid XML: "+data),xml}function ajaxExtend(opts){opts=avalon.mix({},defaults,opts),opts.type=opts.type.toUpperCase();var querystring="string"==typeof opts.data?opts.data:avalon.param(opts.data);if(opts.querystring=querystring||"",opts.url=opts.url.replace(rhash,"").replace(rprotocol,location.protocol+"//"),"boolean"!=typeof opts.crossDomain){var urlAnchor=document.createElement("a");try{urlAnchor.href=opts.url;var absUrl="1"[0]?urlAnchor.href:urlAnchor.getAttribute("href",4);urlAnchor.href=absUrl,opts.crossDomain=originAnchor.protocol+"//"+originAnchor.host!=urlAnchor.protocol+"//"+urlAnchor.host}catch(e){opts.crossDomain=!0}}return opts.hasContent=!rnoContent.test(opts.type),opts.hasContent||(querystring&&(opts.url+=(rquery.test(opts.url)?"&":"?")+querystring),opts.cache===!1&&(opts.url+=(rquery.test(opts.url)?"&":"?")+"_time="+(new Date-0))),opts}function paramInner(prefix,obj,add){var name;if(Array.isArray(obj))avalon.each(obj,function(i,v){rbracket.test(prefix)?add(prefix,v):paramInner(prefix+"["+("object"==typeof v?i:"")+"]",v,add)});else if(avalon.isPlainObject(obj))for(name in obj)paramInner(prefix+"["+name+"]",obj[name],add);else add(prefix,obj)}function tryDecodeURIComponent(value){try{return decodeURIComponent(value)}catch(e){return value}}function addSubObject(host,text,value){var match=text.match(r5b5d);if(!match)return!0;for(var step,index,key,steps=[],first=!0;(index=text.lastIndexOf("%5B"))&&-1!==index;)key=text.slice(index).slice(3,-3),text=text.slice(0,index),steps.unshift(""===key?{action:"pushArrayElement"}:(key>>>0)+""===key?{action:"setSubArray",value:key}:first?{action:"setObjectProperty",value:tryDecodeURIComponent(key)}:{action:"setSubObjet",value:tryDecodeURIComponent(key)}),first=!1;for(first=!0;step=steps.shift();){var isObject=/Object/.test(step.action);switch(first&&(text in host||(host[text]=isObject?{}:[]),first=!1,host=host[text]),step.action){case"pushArrayElement":host.push(value);break;case"setObjectProperty":host[step.value]=value;break;case"setSubObjet":step.value in host||(host[step.value]={}),host=host[step.value];break;case"setSubArray":step.value in host||(host[step.value]=[]),host=host[step.value]}}}function trimLine(val){return val.replace(rline,"\r\n")}var global=this||(0,eval)("this"),DOC=global.document,rlocalProtocol=(encodeURIComponent,decodeURIComponent,/^(?:about|app|app-storage|.+-extension|file|res|widget):$/),rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rhash=/#.*$/,rquery=/\?/,rjsonp=/(=)\?(?=&|$)|\?\?/,r20=/%20/g,radd=/\+/g,r5b5d=/%5B(.*?)%5D$/,originAnchor=document.createElement("a");originAnchor.href=location.href;{var accepts={xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript","*":["*/"]+["*"]};0===IE()||IE()>8}String.prototype.startsWith||(String.prototype.startsWith=function(searchString,position){return position=position||0,this.lastIndexOf(searchString,position)===position});{var head=DOC.head;rlocalProtocol.test(location.protocol)}avalon.xhr=function(){return new XMLHttpRequest};var supportCors="withCredentials"in avalon.xhr(),defaults={type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",async:!0,jsonp:"callback"},XHRMethods={setRequestHeader:function(name,value){return this.requestHeaders[name]=value,this},getAllResponseHeaders:function(){return 4===this.readyState?this.responseHeadersString:null},getResponseHeader:function(name,match){if(4===this.readyState){for(;match=rheaders.exec(this.responseHeadersString);)this.responseHeaders[match[1]]=match[2];match=this.responseHeaders[name]}return void 0===match?null:match},overrideMimeType:function(type){return this.mimeType=type,this},abort:function(statusText){return statusText=statusText||"abort",this.transport&&this.respond(0,statusText),this},dispatch:function(status,nativeStatusText){var statusText=nativeStatusText;if(this.transport){this.readyState=4;var isSuccess=status>=200&&300>status||304===status;if(isSuccess)if(204===status)statusText="nocontent";else if(304===status)statusText="notmodified";else if("undefined"==typeof this.response){var dataType=this.options.dataType||this.options.mimeType;(!dataType&&this.responseText||this.responseXML)&&(dataType=this.getResponseHeader("Content-Type")||"",dataType=dataType.match(/json|xml|script|html/)||["text"],dataType=dataType[0]);var responseText=this.responseText||"",responseXML=this.responseXML||"";try{this.response=avalon.ajaxConverters[dataType].call(this,responseText,responseXML)}catch(e){isSuccess=!1,this.error=e,statusText="parsererror"}}this.status=status,this.statusText=statusText+"",this.timeoutID&&(clearTimeout(this.timeoutID),delete this.timeoutID),this._transport=this.transport;var that=this;isSuccess?(this._resolve([this.response,statusText,this]),window.setTimeout(function(){avalon.ajaxGlobalEvents.success(that,that.options,that.response)},0)):(this._reject([this,statusText,this.error]),window.setTimeout(function(){avalon.ajaxGlobalEvents.error(that,that.options,statusText)},0)),delete this.transport,ajaxActive--,window.setTimeout(function(){avalon.ajaxGlobalEvents.complete(that,that.options)},0),0===ajaxActive&&window.setTimeout(function(){avalon.ajaxGlobalEvents.stop()},0)}}},ajaxActive=0;avalon.ajax=function(opts,promise){opts&&opts.url||avalon.error("参数必须为Object并且拥有url属性"),opts=ajaxExtend(opts);var _reject,_resolve,XHRProperties={responseHeadersString:"",responseHeaders:{},requestHeaders:{},querystring:opts.querystring,readyState:0,uniqueID:(""+Math.random()).replace(/0\./,""),status:0},promise=new avalon.Promise(function(resolve,reject){_resolve=resolve,_reject=reject});promise.options=opts,promise._reject=_reject,promise._resolve=_resolve;var doneList=[],failList=[];Array("done","fail","always").forEach(function(method){promise[method]=function(fn){return"function"==typeof fn&&("fail"!==method&&doneList.push(fn),"done"!==method&&failList.push(fn)),this}});var isSync=opts.async===!1;isSync&&(avalon.log("warnning:与jquery1.8一样,async:false这配置已经被废弃"),promise.async=!1),avalon.mix(promise,XHRProperties,XHRMethods),promise.then(function(value){value=Array.isArray(value)?value:void 0===value?[]:[value];for(var fn,i=0;fn=doneList[i++];)fn.apply(promise,value);return value},function(value){value=Array.isArray(value)?value:void 0===value?[]:[value];for(var fn,i=0;fn=failList[i++];)fn.apply(promise,value);return value}),promise.done(opts.success).fail(opts.error).always(opts.complete);var dataType=opts.dataType,transports=avalon.ajaxTransports;(opts.crossDomain&&!supportCors||rjsonp.test(opts.url))&&"json"===dataType&&"GET"===opts.type&&(dataType=opts.dataType="jsonp");var name=opts.form?"upload":dataType,transport=transports[name]||transports.xhr;avalon.mix(promise,transport),promise.preproccess&&(dataType=promise.preproccess()||dataType),opts.contentType&&promise.setRequestHeader("Content-Type",opts.contentType),promise.setRequestHeader("Accept",accepts[dataType]?accepts[dataType]+", */*; q=0.01":accepts["*"]);for(var i in opts.headers)promise.setRequestHeader(i,opts.headers[i]);return opts.async&&opts.timeout>0&&(promise.timeoutID=setTimeout(function(){promise.abort("timeout"),promise.dispatch(0,"timeout")},opts.timeout)),0===ajaxActive&&avalon.ajaxGlobalEvents.start(),avalon.ajaxGlobalEvents.send(promise,opts),ajaxActive++,promise.request(),promise},"get,post".replace(avalon.rword,function(method){avalon[method]=function(url,data,callback,type){return"function"==typeof data&&(type=type||callback,callback=data,data=void 0),avalon.ajax({type:method,url:url,data:data,success:callback,dataType:type})}}),avalon.getScript=function(url,callback){return avalon.get(url,null,callback,"script")},avalon.getJSON=function(url,data,callback){return avalon.get(url,data,callback,"json")},avalon.upload=function(url,form,data,callback,dataType){return"function"==typeof data&&(dataType=callback,callback=data,data=void 0),avalon.ajax({url:url,type:"post",dataType:dataType,form:form,data:data,success:callback})},avalon.ajaxGlobalEvents={},["start","stop","complete","error","success","send"].forEach(function(method){avalon.ajaxGlobalEvents[method]=avalon.noop}),avalon.ajaxConverters={text:function(text){return text},xml:function(text,xml){return void 0!==xml?xml:parseXML(text)},html:function(text){return avalon.parseHTML(text)},json:function(text){return avalon.parseJSON||avalon.log("avalon.parseJSON不存在,请升级到最新版"),avalon.parseJSON(text)},script:function(text){return parseJS(text),text},jsonp:function(){var json,callbackName;return this.jsonpCallback.startsWith("avalon.")?(callbackName=this.jsonpCallback.replace(/avalon\./,""),json=avalon[callbackName],delete avalon[callbackName]):json=window[this.jsonpCallback],json}};var rbracket=/\[\]$/;avalon.param=function(obj){var prefix,s=[],add=function(key,value){value="function"==typeof value?value():null==value?"":value,s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(Array.isArray(obj))avalon.each(obj,add);else for(prefix in obj)paramInner(prefix,obj[prefix],add);return s.join("&").replace(r20,"+")},avalon.unparam=function(qs,sep,eq){sep=sep||"&",eq=eq||"=";var obj={};if("string"!=typeof qs||0===qs.length)return obj;-1!==qs.indexOf("?")&&(qs=qs.split("?").pop());for(var el,array=qs.split(sep),i=0;el=array[i++];){var arr=el.split("=");if(1===arr.length)obj[arr[0]]="";else{var key=arr[0].replace(radd,"%20"),v=tryDecodeURIComponent(arr.slice(1).join("=").replace(radd," "));if(addSubObject(obj,key,v)){var k=tryDecodeURIComponent(key);Object.prototype.hasOwnProperty.call(obj,k)?Array.isArray(obj[k])?obj[k].push(v):obj[k]=[obj[k],v]:obj[k]=v}}}return obj};var rinput=/select|input|button|textarea/i,rcheckbox=/radio|checkbox/,rline=/\r?\n/g;avalon.serialize=function(form){var json={};return Array.prototype.filter.call(form.getElementsByTagName("*"),function(el){return rinput.test(el.nodeName)&&el.name&&!el.disabled?rcheckbox.test(el.type)?el.checked:!0:void 0}).forEach(function(el){var val=avalon(el).val();val=Array.isArray(val)?val.map(trimLine):trimLine(val);var name=el.name;name in json?Array.isArray(val)?json[name].push(val):json[name]=[json[name],val]:json[name]=val}),avalon.param(json,!1)};var xhrSuccessStatus={0:200,1223:204},transports=avalon.ajaxTransports={xhr:{request:function(){var self=this,opts=this.options,transport=this.transport=new avalon.xhr;transport.open(opts.type,opts.url,opts.async,opts.username,opts.password),this.mimeType&&transport.overrideMimeType&&transport.overrideMimeType(this.mimeType),transport.withCredentials=!0,opts.crossDomain||(this.requestHeaders["X-Requested-With"]="XMLHttpRequest");for(var i in this.requestHeaders)transport.setRequestHeader(i,this.requestHeaders[i]+"");opts.progressCallback&&(transport.upload.onprogress=opts.progressCallback);var dataType=opts.dataType;"responseType"in transport&&/^(blob|arraybuffer|text)$/.test(dataType)&&(transport.responseType=dataType,this.useResponseType=!0),transport.send(opts.hasContent&&(this.formdata||this.querystring)||null),transport.onload=transport.onerror=function(e){this.readyState=4,this.status="load"===e.type?200:500,self.respond()}},respond:function(event,forceAbort){var transport=this.transport;if(transport){forceAbort&&this.timeoutID&&(clearTimeout(this.timeoutID),delete this.timeoutID);var completed=4===transport.readyState;if(forceAbort||completed)if(transport.onerror=transport.onload=null,forceAbort)completed||"function"!=typeof transport.abort||transport.abort();else{var text=transport.responseText,statusText=transport.statusText,status=xhrSuccessStatus[status]||transport.status;this.useResponseType&&(this.response=transport.response),this.responseText="string"==typeof text?text:void 0,this.responseXML=(transport.responseXML||{}).documentElement,this.responseHeadersString=transport.getAllResponseHeaders(),this.dispatch(status,statusText)}}}},jsonp:{preproccess:function(){var opts=this.options,name=this.jsonpCallback=opts.jsonpCallback||"avalon.jsonp"+setTimeout("1");return opts.url=rjsonp.test(opts.url)?opts.url.replace(rjsonp,"$1"+name):opts.url+(rquery.test(opts.url)?"&":"?")+opts.jsonp+"="+name,name.startsWith("avalon.")?(name=name.replace(/avalon\./,""),avalon[name]=function(json){avalon[name]=json}):window[name]=function(json){window[name]=json},"script"}},script:{request:function(){var opts=this.options,node=this.transport=DOC.createElement("script");opts.charset&&(node.charset=opts.charset);var self=this;node.onerror=node.onload=function(){self.respond()},node.src=opts.url,head.insertBefore(node,head.firstChild)},respond:function(event,forceAbort){var node=this.transport;if(node){forceAbort&&this.timeoutID&&(clearTimeout(this.timeoutID),delete this.timeoutID),node.onerror=node.onload=null;var parent=node.parentNode;if(parent&&parent.removeChild(node),!forceAbort){var args;if(this.jsonpCallback){var jsonpCallback=this.jsonpCallback.startsWith("avalon.")?avalon[this.jsonpCallback.replace(/avalon\./,"")]:window[this.jsonpCallback];args="function"==typeof jsonpCallback?[500,"error"]:[200,"success"]}else args=[200,"success"];this.dispatch.apply(this,args)}}}},upload:{preproccess:function(){var formdata,opts=this.options;"function"==typeof opts.form.append?(formdata=opts.form,opts.contentType=""):formdata=new FormData(opts.form),avalon.each(opts.data,function(key,val){formdata.append(key,val)}),this.formdata=formdata}}};return avalon.mix(transports.jsonp,transports.script),avalon.mix(transports.upload,transports.xhr),avalon});
//# sourceMappingURL=mmRequest.modern.js.map